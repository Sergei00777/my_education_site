{% extends "base.html" %}

{% block content %}
<div class="subject-header">
    <h1>–ò—Å—Ç–æ—Ä–∏—è</h1>
    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –≤ –ò—Å—Ç–æ—Ä–∏–∏!</p>
</div>

<div class="subject-content">
    <h2>–¢–µ—Å—Ç –ø–æ –ò—Å—Ç–æ—Ä–∏–∏</h2>
    <p>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ {{ questions|length }} –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è.</p>

    <div class="quiz-container">
        <div class="quiz-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
            <span class="progress-text">–í–æ–ø—Ä–æ—Å 1 –∏–∑ {{ questions|length }}</span>
        </div>

        <div class="quiz-question">
            <h3 id="question-text"></h3>
            <div class="quiz-options" id="options-container"></div>
        </div>

        <div class="quiz-feedback" id="feedback-container" style="display: none;">
            <div class="feedback-message" id="feedback-message"></div>
            <button class="next-btn" id="next-btn">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí</button>
        </div>

        <div class="quiz-results" id="results-container" style="display: none;">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h3>
            <div class="score" id="score-display"></div>
            <button class="restart-btn" id="restart-btn">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç —Å–Ω–æ–≤–∞</button>
        </div>
    </div>
</div>

<script>
const questions = {{ questions|tojson }};
let currentQuestion = 0;
let score = 0;

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const questionText = document.getElementById('question-text');
const optionsContainer = document.getElementById('options-container');
const feedbackContainer = document.getElementById('feedback-container');
const feedbackMessage = document.getElementById('feedback-message');
const nextBtn = document.getElementById('next-btn');
const resultsContainer = document.getElementById('results-container');
const scoreDisplay = document.getElementById('score-display');
const restartBtn = document.getElementById('restart-btn');
const progressFill = document.querySelector('.progress-fill');
const progressText = document.querySelector('.progress-text');

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
function loadQuestion() {
    const question = questions[currentQuestion];
    questionText.textContent = question.question;
    optionsContainer.innerHTML = '';

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const progress = ((currentQuestion) / questions.length) * 100;
    progressFill.style.width = progress + '%';
    progressText.textContent = `–í–æ–ø—Ä–æ—Å ${currentQuestion + 1} –∏–∑ ${questions.length}`;

    // –°–æ–∑–¥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
    question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'option-btn';
        button.textContent = option;
        button.onclick = () => checkAnswer(option);
        optionsContainer.appendChild(button);
    });

    feedbackContainer.style.display = 'none';
    resultsContainer.style.display = 'none';
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
function checkAnswer(selectedAnswer) {
    const question = questions[currentQuestion];

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    fetch('/check_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: question.id,
            answer: selectedAnswer,
            subject: 'history'  // ‚Üê –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä subject
        })
    })
    .then(response => response.json())
    .then(data => {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.disabled = true;
            if (btn.textContent === data.correct_answer) {
                btn.classList.add('correct');
            } else if (btn.textContent === selectedAnswer && !data.correct) {
                btn.classList.add('incorrect');
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º feedback
        if (data.correct) {
            feedbackMessage.innerHTML = '<span class="correct-icon">‚úì</span> –£—Ä–∞! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!';
            feedbackMessage.className = 'feedback-message correct';
            score++;
        } else {
            feedbackMessage.innerHTML = `<span class="incorrect-icon">‚úó</span> –£–≤—ã! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <strong>${data.correct_answer}</strong>`;
            feedbackMessage.className = 'feedback-message incorrect';
        }

        feedbackContainer.style.display = 'block';
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–∞:', error);
        feedbackMessage.innerHTML = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        feedbackMessage.className = 'feedback-message error';
        feedbackContainer.style.display = 'block';
    });
}

// –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
nextBtn.addEventListener('click', () => {
    currentQuestion++;

    if (currentQuestion < questions.length) {
        loadQuestion();
    } else {
        showResults();
    }
});

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function showResults() {
    questionText.style.display = 'none';
    optionsContainer.style.display = 'none';
    feedbackContainer.style.display = 'none';

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ 100%
    progressFill.style.width = '100%';
    progressText.textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!';

    scoreDisplay.innerHTML = `
        <div class="final-score">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${score} –∏–∑ ${questions.length}</div>
        <div class="score-percentage">${Math.round((score / questions.length) * 100)}%</div>
        <div class="money-earned">üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${score} —Ä—É–±–ª–µ–π</div>
        <div class="correct-answers">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${score}</div>
        <div class="total-questions">üìä –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${questions.length}</div>
    `;
    resultsContainer.style.display = 'block';
}

// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
restartBtn.addEventListener('click', () => {
    currentQuestion = 0;
    score = 0;
    questionText.style.display = 'block';
    optionsContainer.style.display = 'block';
    loadQuestion();
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
loadQuestion();
</script>
{% endblock %}